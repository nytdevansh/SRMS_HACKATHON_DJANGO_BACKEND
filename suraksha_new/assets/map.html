<!DOCTYPE html>
<html>
<head>
    <title>TomTom Map</title>
    <link rel='stylesheet' type='text/css' href='https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.1/maps/maps.css'>
    <script src='https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.1/maps/maps-web.min.js'></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        #error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            max-width: 80%;
            display: none;
            z-index: 1000;
        }
        .marker-icon {
            background-color: #4a90e2;
            border-radius: 50%;
            border: 2px solid white;
            width: 24px;
            height: 24px;
        }
        .current-location {
            background-color: #ff4444;
        }
    </style>
</head>
<body>
    <div id='map'></div>
    <div id='error-message'></div>
    <script>
        let map;
        let markers = [];
        const API_KEY = '5c7OPcT95AodKEGXjWafwWLcXBgVzbzr';
        
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            console.error(message);
        }
        
        function initMap() {
            try {
                if (!tt) {
                    showError('TomTom SDK not loaded. Check your internet connection.');
                    return;
                }
                
                map = tt.map({
                    key: API_KEY,
                    container: 'map',
                    center: [77.2090, 28.6139], // Default center
                    zoom: 13,
                    language: 'en-GB',
                    stylesVisibility: {
                        trafficIncidents: true,
                        trafficFlow: true
                    }
                });
                
                map.on('error', function(e) {
                    showError('Map error: ' + e.error);
                });
                
                map.addControl(new tt.FullscreenControl());
                map.addControl(new tt.NavigationControl());
                map.addControl(new tt.GeolocateControl({
                    positionOptions: {
                        enableHighAccuracy: true
                    },
                    trackUserLocation: true,
                    showUserLocation: true
                }));
                
                console.log('Map initialized successfully');
            } catch (error) {
                showError('Failed to initialize map: ' + error.message);
            }
        }
        
        // Function to be called from Flutter
        function addMarker(lng, lat, isCurrentLocation) {
            try {
                if (!map) {
                    console.error('Map not initialized');
                    return;
                }
                
                // Validate coordinates
                if (isNaN(lng) || isNaN(lat)) {
                    console.error('Invalid coordinates:', lng, lat);
                    return;
                }
                
                const el = document.createElement('div');
                el.className = 'marker-icon' + (isCurrentLocation ? ' current-location' : '');
                const marker = new tt.Marker({element: el})
                    .setLngLat([lng, lat])
                    .addTo(map);
                
                markers.push(marker);
                console.log('Marker added at:', lng, lat, isCurrentLocation ? '(current location)' : '');
            } catch (error) {
                console.error('Error adding marker:', error);
            }
        }

        // Function to update map center
        function updateMapCenter(lng, lat, zoom) {
            try {
                if (!map) {
                    console.error('Map not initialized');
                    return;
                }
                
                // Validate coordinates
                if (isNaN(lng) || isNaN(lat)) {
                    console.error('Invalid coordinates for map center:', lng, lat);
                    return;
                }
                
                map.flyTo({
                    center: [lng, lat],
                    zoom: zoom || 13,
                    duration: 1000
                });
                console.log('Map center updated to:', lng, lat, 'zoom:', zoom);
            } catch (error) {
                console.error('Error updating map center:', error);
            }
        }
        
        // Clear all markers except current location
        function clearMarkers(keepCurrentLocation = true) {
            try {
                markers.forEach((marker, index) => {
                    if (!keepCurrentLocation || index > 0) {
                        marker.remove();
                    }
                });
                
                if (keepCurrentLocation && markers.length > 0) {
                    markers = [markers[0]];
                } else {
                    markers = [];
                }
                console.log('Markers cleared');
            } catch (error) {
                console.error('Error clearing markers:', error);
            }
        }
        
        // Initialize the map
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
